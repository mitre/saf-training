---
index: 10
title: 10. Building Out Our Pipeline
author: Will Dower
headerDepth: 3
---

## More Pipeline Steps

Let's make this pipeline deploy, harden, validate, and verify an NGINX container. We will add many steps 

### Prep Steps

First, we need to make sure that the node that runs our pipeline will have access to the executables it needs. By default, Gitub's runners have quite a bit of software pre-installed, including Docker and Ansible (see the full list [here](https://github.com/actions/runner-images/blob/main/images/linux/Ubuntu2004-Readme.md)). However, the Ubuntu image we are using does not have InSpec installed, nor does it have a copy of our test code. Let's add to our pipeline file to fix this.

::: code-tabs#shell
@tab Adding More Steps
``` yaml
- name: PREP - Install InSpec executable 
  run: curl https://omnitruck.chef.io/install.sh | sudo bash -s -- -P inspec -v 5

- name: PREP - Check out this repository  # because that's where our profile is!
  uses: actions/checkout@v3
```
@tab `pipeline.yml` after adding more steps
``` yaml
name: Demo Security Validation Gold Image Pipeline

on:
  push:
    branches: [main] # trigger this action on any push to main branch

jobs:
  gold-image:
    name: Gold Image NGINX
    runs-on: ubuntu-20.04
    env:
      CHEF_LICENSE: accept # so that we can use InSpec without manually accepting the license
      PROFILE: my_nginx # path to our profile
    steps:
      - name: PREP - Update runner # updating all dependencies is always a good start
        run: sudo apt-get update

      - name: PREP - Install InSpec executable 
        run: curl https://omnitruck.chef.io/install.sh | sudo bash -s -- -P inspec -v 5

      - name: PREP - Check out this repository  # because that's where our profile is!
        uses: actions/checkout@v3
```
:::

The first new step installs the InSpec executable using the install instructions for Ubuntu as given [here](https://docs.chef.io/inspec/install/#cli-1). Remember that GitHub gives us a brand-new runner node every time we execute the pipeline; if we don't install it and it isn't on the pre-installed software list, it won't be available!

### Actions
The next step ("PREP - Check out this repository") is our first one to use an Action. Actions are pre-packaged pipeline steps published to the [GitHub Marketplace](https://github.com/marketplace?type=). Any project or developer can publish an Action to the Marketplace as part of the GitHub Actions ecosystem. Most other orchestration tools for pipelines have a similar plugin system.

We can use Actions as shortcuts in the same way we use InSpec resources to abstract out quite a bit of test code logic.
Actions are invoked with the `uses` attribute in a step in place of the `run` attribute we have been using so far, which simply executes a terminal command.

This Action in particular is one of the most common -- [`checkout`](https://github.com/marketplace/actions/checkout). If called with no other attributes attached to it, it simply checks out the repository where the workflow file lives to the runner that is currently executing the workflow. We need to do this to make sure we have access to InSpec profile you created earlier!

### Linting

Most CI pipelines will also include a lint step, where the code is statically tested to make sure that it does not contain errors that we can spot before we even execute it, and to make sure it is conforming to a project style guide. For our purposes, it's a good idea to run the `inspec check` command to ensure that InSpec can recognize our tests as a real profile.

::: Note We can run InSpec inside this runner now because we installed it in a prior step!
:::

Let's add the lint step:

::: code-tabs#shell
@tab Adding More Step
``` yaml
- name: LINT - Run InSpec Check           # double-check that we don't have any serious issues in our profile code
  run: inspec check my_nginx
```
@tab `pipeline.yml` after adding more steps
``` yaml
name: Demo Security Validation Gold Image Pipeline

on:
  push:
    branches: [main] # trigger this action on any push to main branch

jobs:
  gold-image:
    name: Gold Image NGINX
    runs-on: ubuntu-20.04
    env:
      CHEF_LICENSE: accept # so that we can use InSpec without manually accepting the license
      PROFILE: my_nginx # path to our profile
    steps:
      - name: PREP - Update runner # updating all dependencies is always a good start
        run: sudo apt-get update

      - name: PREP - Install InSpec executable 
        run: curl https://omnitruck.chef.io/install.sh | sudo bash -s -- -P inspec -v 5

      - name: PREP - Check out this repository  # because that's where our profile is!
        uses: actions/checkout@v3
        
      - name: LINT - Run InSpec Check           # double-check that we don't have any serious issues in our profile code
        run: inspec check my_nginx
```
:::

