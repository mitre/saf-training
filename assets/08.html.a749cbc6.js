import{_ as a}from"./plugin-vue_export-helper.21dcd24c.js";import{o as e,c as t,F as i,a as n,e as s,d as p}from"./app.3b4d192a.js";const o={},l=n("p",null,[s("Let's practice creating our own custom resource. Let's say we want to write tests that examine the current state of a local Git repository. We want to create a "),n("code",null,"git"),s(" resource to handle all of InSpec's interactions with the Git repo under the hood, so that we can focus on writing clean and easy-to-read profile code.")],-1),c=n("p",null,"Let's take a look at this InSpec video that walks through this example and then try it out ourselves.",-1),r=n("div",{class:"video-container"},[n("iframe",{width:"1028",height:"578",src:"https://www.youtube.com/embed/Xka2xT6Cngg?list=PLSZbtIlMt5rcbXOpMRucKzRMXR7HX7awy",title:"YouTube video player",frameborder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowfullscreen:""})],-1),d=p(`<h3 id="_8-1-create-new-inspec-profile" tabindex="-1"><a class="header-anchor" href="#_8-1-create-new-inspec-profile" aria-hidden="true">#</a> 8.1. Create new InSpec profile</h3><p>Let&#39;s start by creating a new profile:</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>inspec init profile <span class="token function">git</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_8-2-develop-controls-to-test-run-profile" tabindex="-1"><a class="header-anchor" href="#_8-2-develop-controls-to-test-run-profile" aria-hidden="true">#</a> 8.2. Develop controls to test / run profile</h3><p>Now let&#39;s write some controls and test that they run:</p><div class="language-ruby ext-rb line-numbers-mode"><pre class="language-ruby"><code><span class="token comment"># encoding: utf-8</span>
<span class="token comment"># copyright: 2018, The Authors</span>

git_dir <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;/home/chef/apache/.git&quot;</span></span>

<span class="token comment"># The following banches should exist</span>
describe command<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;git --git-dir </span><span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token content">git_dir</span><span class="token delimiter punctuation">}</span></span><span class="token string"> branch&quot;</span></span><span class="token punctuation">)</span> <span class="token keyword">do</span>
  its<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&#39;stdout&#39;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> should match <span class="token regex-literal"><span class="token regex">/master/</span></span> <span class="token punctuation">}</span>
<span class="token keyword">end</span>

describe command<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;git --git-dir </span><span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token content">git_dir</span><span class="token delimiter punctuation">}</span></span><span class="token string"> branch&quot;</span></span><span class="token punctuation">)</span> <span class="token keyword">do</span>
  its<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&#39;stdout&#39;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> should match <span class="token regex-literal"><span class="token regex">/testBranch/</span></span> <span class="token punctuation">}</span>
<span class="token keyword">end</span>

<span class="token comment"># What is the current branch</span>
describe command<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;git --git-dir </span><span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token content">git_dir</span><span class="token delimiter punctuation">}</span></span><span class="token string"> branch&quot;</span></span><span class="token punctuation">)</span> <span class="token keyword">do</span>
  its<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&#39;stdout&#39;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> should match <span class="token regex-literal"><span class="token regex">/^\\* master/</span></span> <span class="token punctuation">}</span>
<span class="token keyword">end</span>

<span class="token comment"># What is the latest commit</span>
describe command<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;git --git-dir </span><span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token content">git_dir</span><span class="token delimiter punctuation">}</span></span><span class="token string"> log -1 --pretty=format:&#39;%h&#39;&quot;</span></span><span class="token punctuation">)</span> <span class="token keyword">do</span>
  its<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&#39;stdout&#39;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> should match <span class="token regex-literal"><span class="token regex">/edc207f/</span></span> <span class="token punctuation">}</span>
<span class="token keyword">end</span>

<span class="token comment"># What is the second to last commit</span>
describe command<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;git --git-dir </span><span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token content">git_dir</span><span class="token delimiter punctuation">}</span></span><span class="token string"> log --skip=1 -1 --pretty=format:&#39;%h&#39;&quot;</span></span><span class="token punctuation">)</span> <span class="token keyword">do</span>
  its<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&#39;stdout&#39;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> should match <span class="token regex-literal"><span class="token regex">/8c30bff/</span></span> <span class="token punctuation">}</span>
<span class="token keyword">end</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-3-rewrite-test" tabindex="-1"><a class="header-anchor" href="#_8-3-rewrite-test" aria-hidden="true">#</a> 8.3. Rewrite test</h3><p>Let&#39;s rewrite the first test in our example file as follows:</p><div class="language-ruby ext-rb line-numbers-mode"><pre class="language-ruby"><code><span class="token comment"># The following banches should exist</span>
describe git<span class="token punctuation">(</span>git_dir<span class="token punctuation">)</span> <span class="token keyword">do</span>
  its<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&#39;branches&#39;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> should <span class="token keyword">include</span> <span class="token string-literal"><span class="token string">&#39;master&#39;</span></span> <span class="token punctuation">}</span>
<span class="token keyword">end</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now let&#39;s run the profile.</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>inspec <span class="token builtin class-name">exec</span> <span class="token function">git</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>We should get an error because the git method and resource are not defined yet. We should fix that.</p><h3 id="_8-4-develop-git-resources" tabindex="-1"><a class="header-anchor" href="#_8-4-develop-git-resources" aria-hidden="true">#</a> 8.4. Develop git resources</h3><p>Let&#39;s start by creating a new file called git.rb in the libraries directory. The content of the file should look like this:</p><div class="language-ruby ext-rb line-numbers-mode"><pre class="language-ruby"><code><span class="token comment"># encoding: utf-8</span>
<span class="token comment"># copyright: 2019, The Authors</span>

<span class="token keyword">class</span> <span class="token class-name">Git</span> <span class="token operator">&lt;</span> Inspec<span class="token punctuation">.</span>resource<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    name <span class="token string-literal"><span class="token string">&#39;git&#39;</span></span>

<span class="token keyword">end</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">Setting Up a Resource Using InSpec Init</p><p>Instead of just creating the <code>git.rb</code> file in the <code>libraries</code> directory, you can use InSpec to assist you in creating a resource. Run <code>inspec init resource &lt;your-resource-name&gt;</code> and follow the prompts to create the foundation and see examples for a resource.</p></div><p>Now run the profile again.</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>inspec <span class="token builtin class-name">exec</span> <span class="token function">git</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>This time we get another error letting us know that we have a resource that has been given the incorrect number of arguments. This means we have given an additional parameter to this resource that we have not yet accepted.</p><p>Each resource will require an initialization method.</p><p>For our git.rb file let&#39;s add that initialization method:</p><div class="language-ruby ext-rb line-numbers-mode"><pre class="language-ruby"><code><span class="token comment"># encoding: utf-8</span>
<span class="token comment"># copyright: 2019, The Authors</span>

<span class="token keyword">class</span> <span class="token class-name">Git</span> <span class="token operator">&lt;</span> Inspec<span class="token punctuation">.</span>resource<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    name <span class="token string-literal"><span class="token string">&#39;git&#39;</span></span>

    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">initialize</span></span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
        <span class="token variable">@path</span> <span class="token operator">=</span> path
    <span class="token keyword">end</span>

<span class="token keyword">end</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This is saving the path we are passing in from the control into an instance method called <code>path</code>.</p><p>Now when we run the profile.</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>inspec <span class="token builtin class-name">exec</span> <span class="token function">git</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>The test will run but we will get an error saying we do not have a <code>branches</code> method.</p><p>So let&#39;s go back to our git.rb file to fix that by adding a <code>branches</code> method:</p><div class="language-ruby ext-rb line-numbers-mode"><pre class="language-ruby"><code><span class="token comment"># encoding: utf-8</span>
<span class="token comment"># copyright: 2019, The Authors</span>

<span class="token keyword">class</span> <span class="token class-name">Git</span> <span class="token operator">&lt;</span> Inspec<span class="token punctuation">.</span>resource<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    name <span class="token string-literal"><span class="token string">&#39;git&#39;</span></span>

    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">initialize</span></span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
        <span class="token variable">@path</span> <span class="token operator">=</span> path
    <span class="token keyword">end</span>

    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">branches</span></span>

    <span class="token keyword">end</span>

<span class="token keyword">end</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>We have now defined the branches method. Let&#39;s see what the test output shows us.</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>inspec <span class="token builtin class-name">exec</span> <span class="token function">git</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>Now the error message says that the <code>branches</code> method is returning a null value when it&#39;s expecting an array or something that is able to accept the include method invoked on it.</p><p>We can use the InSpec helper method which enables you to invoke any other inspec resource as seen below:</p><div class="language-ruby ext-rb line-numbers-mode"><pre class="language-ruby"><code><span class="token comment"># encoding: utf-8</span>
<span class="token comment"># copyright: 2019, The Authors</span>

<span class="token keyword">class</span> <span class="token class-name">Git</span> <span class="token operator">&lt;</span> Inspec<span class="token punctuation">.</span>resource<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    name <span class="token string-literal"><span class="token string">&#39;git&#39;</span></span>

    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">initialize</span></span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
        <span class="token variable">@path</span> <span class="token operator">=</span> path
    <span class="token keyword">end</span>

    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">branches</span></span>
        inspec<span class="token punctuation">.</span>command<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;git --git-dir </span><span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token content"><span class="token variable">@path</span></span><span class="token delimiter punctuation">}</span></span><span class="token string"> branch&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>stdout
    <span class="token keyword">end</span>

<span class="token keyword">end</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>We have borrowed the built-in <code>command</code> resource to handle running Git&#39;s CLI commands.</p><p>Now we see that we get a passing test!</p><p>Now let&#39;s adjust our test to also check for our second branch that we created earlier as well as check our current branch:</p><div class="language-ruby ext-rb line-numbers-mode"><pre class="language-ruby"><code><span class="token comment"># The following banches should exist</span>
describe git<span class="token punctuation">(</span>git_dir<span class="token punctuation">)</span> <span class="token keyword">do</span>
  its<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&#39;branches&#39;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> should <span class="token keyword">include</span> <span class="token string-literal"><span class="token string">&#39;master&#39;</span></span> <span class="token punctuation">}</span>
  its<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&#39;branches&#39;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> should <span class="token keyword">include</span> <span class="token string-literal"><span class="token string">&#39;testBranch&#39;</span></span> <span class="token punctuation">}</span>
  its<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&#39;current_branch&#39;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> should cmp <span class="token string-literal"><span class="token string">&#39;master&#39;</span></span> <span class="token punctuation">}</span>
<span class="token keyword">end</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Let&#39;s head over to the git.rb file to create the <code>current_branch</code> method we are invoking in the above test:</p><div class="language-ruby ext-rb line-numbers-mode"><pre class="language-ruby"><code><span class="token comment"># encoding: utf-8</span>
<span class="token comment"># copyright: 2019, The Authors</span>

<span class="token keyword">class</span> <span class="token class-name">Git</span> <span class="token operator">&lt;</span> Inspec<span class="token punctuation">.</span>resource<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    name <span class="token string-literal"><span class="token string">&#39;git&#39;</span></span>

    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">initialize</span></span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
        <span class="token variable">@path</span> <span class="token operator">=</span> path
    <span class="token keyword">end</span>

    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">branches</span></span>
        inspec<span class="token punctuation">.</span>command<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;git --git-dir </span><span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token content"><span class="token variable">@path</span></span><span class="token delimiter punctuation">}</span></span><span class="token string"> branch&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>stdout
    <span class="token keyword">end</span>

    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">current_branch</span></span>
        branch_name <span class="token operator">=</span> inspec<span class="token punctuation">.</span>command<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;git --git-dir </span><span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token content"><span class="token variable">@path</span></span><span class="token delimiter punctuation">}</span></span><span class="token string"> branch&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>strip<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;\\n&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>find <span class="token keyword">do</span> <span class="token operator">|</span>name<span class="token operator">|</span>
            name<span class="token punctuation">.</span>start_with<span class="token operator">?</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&#39;*&#39;</span></span><span class="token punctuation">)</span>
        <span class="token keyword">end</span>
        branch_name<span class="token punctuation">.</span>gsub<span class="token punctuation">(</span><span class="token regex-literal"><span class="token regex">/^\\*/</span></span><span class="token punctuation">,</span><span class="token string-literal"><span class="token string">&#39;&#39;</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip
    <span class="token keyword">end</span>

<span class="token keyword">end</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now we can run the profile again.</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>inspec <span class="token builtin class-name">exec</span> <span class="token function">git</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>All the tests should pass!</p><p><strong>EXERCISE:</strong><br> As a solo exercise, try to create a method in the git.rb file to check what the last commit is.</p>`,43);function u(k,m){return e(),t(i,null,[l,c,r,d],64)}var b=a(o,[["render",u],["__file","08.html.vue"]]);export{b as default};
